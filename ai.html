<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Med AI Tutor</title>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      background:#f4f7fb; 
      margin:0; 
      padding:0; 
      display:flex; 
      flex-direction:column; 
      align-items:center; 
    }

    header {
      width:100%;
      background:#2a5c8f;
      color:white;
      padding:15px;
      text-align:center;
      font-size:20px;
      font-weight:bold;
    }

    #chatbox {
      width:90%;
      max-width:600px;
      background:#fff;
      border:1px solid #ccc;
      border-radius:8px;
      padding:15px;
      margin-top:20px;
      min-height:400px;
      max-height: 60vh;
      overflow-y:auto;
      box-shadow:0 4px 6px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
    }

    .msg { 
      margin:10px 0; 
      padding:10px; 
      border-radius:6px; 
      max-width:80%; 
      word-wrap:break-word;
    }

    .user { 
      background:#d1e7ff; 
      margin-left:auto; 
      text-align:right; 
    }

    .bot { 
      background:#e8f5e9; 
      margin-right:auto; 
      text-align:left; 
    }

    .error {
      background: #ffebee;
      color: #c62828;
    }

    .thinking {
      font-style: italic;
      color: #7f8c8d;
    }

    #controls {
      width:90%;
      max-width:600px;
      margin:15px auto;
      display:flex;
      gap:10px;
    }

    #inputBox { 
      flex:1; 
      padding:12px; 
      border-radius:6px; 
      border:1px solid #ccc; 
      font-size:16px; 
    }

    #sendBtn { 
      padding:12px 20px; 
      background:#2a5c8f; 
      color:white; 
      border:none; 
      border-radius:6px; 
      cursor:pointer; 
      font-size:16px;
    }

    #backBtn {
      margin:20px;
      padding:12px 20px; 
      background:#4caf50; 
      color:white; 
      border:none; 
      border-radius:6px; 
      cursor:pointer;
      font-size:16px;
    }

    #tokenContainer {
      width: 90%;
      max-width: 600px;
      margin: 10px auto;
      padding: 10px;
      background: #fff3cd;
      border-radius: 6px;
      border: 1px solid #ffeaa7;
    }

    #tokenInput {
      width: 100%;
      padding: 8px;
      margin: 8px 0;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    #tokenNote {
      font-size: 14px;
      color: #856404;
    }

    #backBtn:hover, #sendBtn:hover {
      opacity:0.9;
    }

    .loader {
      display: inline-block;
      width: 12px;
      height: 12px;
      border: 2px solid #f3f3f3;
      border-radius: 50%;
      border-top: 2px solid #3498db;
      animation: spin 1s linear infinite;
      margin-right: 5px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <header>ü©∫ Med AI Tutor (Beta)</header>

  <div id="tokenContainer">
    <p><strong>API Token Required:</strong> You need a Hugging Face API token to use this service.</p>
    <input type="password" id="tokenInput" placeholder="Paste your Hugging Face API token here">
    <p id="tokenNote">Get your free token at <a href="https://huggingface.co/settings/tokens" target="_blank">Hugging Face</a>. Your token is stored only in your browser.</p>
  </div>

  <div id="chatbox"></div>

  <div id="controls">
    <input type="text" id="inputBox" placeholder="Ask a medical question..." disabled>
    <button id="sendBtn" disabled>Send</button>
  </div>

  <a href="index.html"><button id="backBtn">‚¨ÖÔ∏è Back to Home</button></a>

  <script>
    // Hugging Face API endpoint (small model for free use)
    const API_URL = "https://api-inference.huggingface.co/models/google/flan-t5-small"; 

    // Elements
    const chatbox = document.getElementById("chatbox");
    const inputBox = document.getElementById("inputBox");
    const sendBtn = document.getElementById("sendBtn");
    const tokenInput = document.getElementById("tokenInput");
    const tokenContainer = document.getElementById("tokenContainer");

    // Store conversation history
    let conversation = [];
    let hfToken = "";

    // Add messages to chat window
    function addMessage(text, sender, isThinking = false) {
      const div = document.createElement("div");
      div.className = `msg ${sender} ${isThinking ? 'thinking' : ''}`;
      
      if (isThinking) {
        const loader = document.createElement("div");
        loader.className = "loader";
        div.appendChild(loader);
        const textNode = document.createTextNode(text);
        div.appendChild(textNode);
      } else {
        div.innerText = text;
      }
      
      chatbox.appendChild(div);
      chatbox.scrollTop = chatbox.scrollHeight;
      return div;
    }

    // Show error message
    function showError(message) {
      const div = document.createElement("div");
      div.className = "msg error";
      div.innerText = message;
      chatbox.appendChild(div);
      chatbox.scrollTop = chatbox.scrollHeight;
    }

    // Query Hugging Face model with memory
    async function queryModel(question) {
      // Add user message to history
      conversation.push("User: " + question);
      addMessage(question, "user");
      
      const thinkingElement = addMessage("Thinking...", "bot", true);

      try {
        // Send the whole conversation as input
        const prompt = conversation.join("\n") + "\nAI:";

        const response = await fetch(API_URL, {
          method: "POST",
          headers: { 
            "Authorization": `Bearer ${hfToken}`, 
            "Content-Type": "application/json" 
          },
          body: JSON.stringify({ inputs: prompt })
        });

        if (!response.ok) {
          if (response.status === 401) {
            throw new Error("Invalid API token. Please check your token and try again.");
          } else if (response.status === 503) {
            throw new Error("Model is loading. Please try again in a few moments.");
          } else {
            throw new Error(`API error: ${response.status} ${response.statusText}`);
          }
        }

        const result = await response.json();

        let answer = result[0]?.generated_text || "Sorry, I couldn't generate an answer.";
        // Clean up answer (remove "AI:" if present)
        answer = answer.replace(/^AI:\s*/i, "").trim();

        // Save bot reply in memory
        conversation.push("AI: " + answer);

        // Replace "Thinking..." with actual answer
        thinkingElement.innerHTML = answer;
        thinkingElement.classList.remove('thinking');
      } catch (error) {
        console.error("Error:", error);
        thinkingElement.remove();
        showError(`Error: ${error.message}`);
      }
    }

    // Handle token input
    tokenInput.addEventListener('input', function() {
      hfToken = this.value.trim();
      const hasToken = hfToken.length > 0;
      
      inputBox.disabled = !hasToken;
      sendBtn.disabled = !hasToken;
      
      if (hasToken) {
        // Save token to localStorage
        localStorage.setItem('hfToken', hfToken);
        addMessage("Token saved. You can now ask medical questions.", "bot");
      }
    });

    // Check for saved token
    window.addEventListener('DOMContentLoaded', function() {
      const savedToken = localStorage.getItem('hfToken');
      if (savedToken) {
        tokenInput.value = savedToken;
        hfToken = savedToken;
        inputBox.disabled = false;
        sendBtn.disabled = false;
        addMessage("Welcome back! You can continue with your medical questions.", "bot");
      } else {
        addMessage("Please enter your Hugging Face API token to begin.", "bot");
      }
    });

    // Send button
    sendBtn.onclick = () => {
      const q = inputBox.value.trim();
      if (q) { 
        queryModel(q); 
        inputBox.value = ""; 
      }
    };

    // Enter key to send
    inputBox.addEventListener("keypress", (e) => {
      if (e.key === "Enter") sendBtn.click();
    });
  </script>
</body>
</html>
